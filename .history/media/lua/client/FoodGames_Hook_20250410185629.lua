--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


-- coded by Monkey
-- refactored by Glytch3r to prevent possible mod conflict due to vanilla overwrite


-----------------------            ---------------------------
FoodGames = FoodGames or {}


function FoodGames.init()
    local hook_start = ISEatFoodAction.start


    local function convertDaysToYMD(days)
        local years = math.floor(days / 365)
        days = days % 365
        local months = math.floor(days / 30)
        days = days % 30

        return string.format("Y%d M%d D%d", years, months, days)
    end

    function ISEatFoodAction:start()
        hook_start(self)
        self.originalCalories = self.item:getCalories()
        self.character:reportEvent("EventEating")
    end


    local hook_stop = ISEatFoodAction.stop
    function ISEatFoodAction:stop()
        hook_stop(self)
        if self.item and self.item:getFullType() ~= "Base.Cigarettes" and self.character:getInventory():contains(self.item) then
            self:handleFoodGamesCaloriesAfterEat(false)
        end
    end

    local hook_perform = ISEatFoodAction.perform
    function ISEatFoodAction:perform()
        self:handleFoodGamesCaloriesAfterEat(true)
        return hook_perform(self)
    end

    function ISEatFoodAction:handleFoodGamesCaloriesAfterEat(isPerform)
        self.remainingCalories = self.item:getCalories()
        local dbg = getCore():getDebug()
        if dbg then
            print('----------[FoodGames]----------')
            print('[FoodGames] Percentage: ' .. self.percentage)
            print('[FoodGames] Initial Calories: ' .. self.originalCalories)
            print('[FoodGames] Remaining Calories: ' .. self.remainingCalories)
        end

        local consumedCalories = self.originalCalories - self.remainingCalories
        if isPerform then
            consumedCalories = self.originalCalories
        end

        local playerMd = self.character:getModData()
        playerMd['FoodGames'] = playerMd['FoodGames'] or {}
        playerMd['FoodGames']['consumedCalories'] = playerMd['FoodGames']['consumedCalories'] or 0
        local consumedCaloriesSnapshot = playerMd['FoodGames']['consumedCalories']
        local daysOfCaloriesSnapshot = math.floor(consumedCaloriesSnapshot / SandboxVars.FoodGames.DailyCalories)
        playerMd['FoodGames']['consumedCalories'] = playerMd['FoodGames']['consumedCalories'] + consumedCalories
        local newDaysOfCalories = math.floor(playerMd['FoodGames']['consumedCalories'] / SandboxVars.FoodGames.DailyCalories)
        local daysChange = newDaysOfCalories - daysOfCaloriesSnapshot

        if dbg then
            print('----------[FoodGames]----------')
            print('Consumed Calories: ' .. consumedCalories)
            print('daysOfCaloriesSnapshot: ' .. daysOfCaloriesSnapshot)
            print('newDaysOfCalories: ' .. newDaysOfCalories)
            print('Player Consumed Calories: ' .. playerMd['FoodGames']['consumedCalories'])
            print("Days Change: " .. daysChange)
        end

        if daysChange <= 0 then
            self.character:setHaloNote('Calories Stored: ' .. convertDaysToYMD(newDaysOfCalories))
            return
        end

        local item = InventoryItemFactory.CreateItem("Base.ChessWhite")
        local inventory = self.character:getInventory()
        if inventory then
            inventory:DoAddItem(item)
            inventory:setDrawDirty(true)
        end
        self.character:getInventory():setDrawDirty(true)
        ISInventoryPage.dirtyUI()
        self.character:setHaloNote(getText("You have gained another day's food token! Calories Stored: ") .. convertDaysToYMD(newDaysOfCalories))
    end

    local hook_new = ISEatFoodAction.new
    function ISEatFoodAction:new(character, item, percentage)
        local o = hook_new(self, character, item, percentage)
        o.originalCalories = 0
        o.remainingCalories = 0
        return o
    end

    -----------------------            ---------------------------



end

Events.OnCreatePlayer.Add(FoodGames.init)

-----------------------            ---------------------------
