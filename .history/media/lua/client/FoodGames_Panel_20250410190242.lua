--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

FoodGames = FoodGames or {}

require "ISUI/ISCollapsableWindow"

FoodGamesPanel = ISCollapsableWindow:derive("FoodGamesPanel")

function FoodGames.refresh()
    if FoodGamesPanel.instance ~= nil then
        FoodGamesPanel:close()
        FoodGames.create()
    end
end

function FoodGamesPanel:close()
    if FoodGamesPanel.instance ~= nil then
        FoodGamesPanel.instance:setVisible(false)
        FoodGamesPanel.instance:removeFromUIManager()
        FoodGamesPanel.instance = nil
    end
end


function FoodGamesPanel:createChildren()
    ISCollapsableWindow.createChildren(self)

    self:setTitle("Food Game Calories");
    --self:setHeight(200);
    --self:setWidth(270);

    self.icon = ISImage:new(10, 25, 32, 32, getTexture("media/ui/HomeLenderIcon.png"));
    self.icon.scaled = true;
    self:addChild(self.icon);

    self.CalSlider = ISSliderPanel:new(10, self.height / 4 + 32, 250, 32, self, self.OnSliderChange)
    self.CalSlider.anchorTop = false
    self.CalSlider.anchorBottom = true
    self.CalSlider:initialise()
    self.CalSlider:instantiate()


    self.CalSlider:setValues(0.0, 99999, 0.1, 1, true)
    self.CalSlider:setHeight(32)
    self:addChild(self.CalSlider)

    local data = self.player:getModData()['FoodGames'] and self.player:getModData()['FoodGames']['consumedCalories'] or 0
    self.CalSlider:setCurrentValue(data)
    self.CalSlider.sliderColor = self.backgroundColor
   -- self.CalSlider.valueLabel=tostring(data)
end
function FoodGamesPanel:prerender()
    ISCollapsableWindow.prerender(self)
    local th = self:titleBarHeight()
    local text = self.player:getModData()['FoodGames']['consumedCalories']
    --self:drawTextureScaled(self.titlebarbkg, 2, 1, self:getWidth() - 4, th - 2, 1, 1, 1, 1);
    --self:drawRectBorder(0, 0, self.width, self.height, self.borderColor.a, self.borderColor.r, self.borderColor.g, self.borderColor.b);
    self:drawTextCentre(tostring(self.CalSlider:getCurrentValue()), self:getWidth() / 2, 32, 0.76, 0.59, 0.11, 1, UIFont.Large);
    --self:drawRect(0, 5, self.width, self.height, self.backgroundColor.a, self.backgroundColor.r, self.backgroundColor.g, self.backgroundColor.b);
end


function FoodGames.open()
    local modData = getPlayer():getModData()
    modData['FoodGames'] = modData['FoodGames'] or {}
    modData['FoodGames']['consumedCalories'] = modData['FoodGames']['consumedCalories'] or 0

    if FoodGamesPanel.instance == nil then
        local sW = getCore():getScreenWidth()
        local sH = getCore():getScreenHeight()
        local sX = sW / 3 - 100
        local sY = sH / 2 - 350
        local W = 272
        local H = 122

        FoodGamesPanel.instance = FoodGamesPanel:new(sX, sY, W, H, getPlayer())
        FoodGamesPanel.instance:initialise()
        FoodGamesPanel.instance:addToUIManager()
        return FoodGamesPanel.instance
    else
        FoodGamesPanel.instance:close()
    end
end



function FoodGamesPanel:OnSliderChange()
    --self.calData = self.CalSlider:getCurrentValue()
   --self.CalSlider:setCurrentValue(self.calData)
    self.CalSlider.sliderColor = self.borderColor
    self.player:getModData()['FoodGames']['consumedCalories']  =  self.CalSlider:getCurrentValue()
    --print(self.calData)
end
function FoodGamesPanel:update()
    ISCollapsableWindow.update(self)

--[[     if self.CalSlider and self.player and self.player:getModData() then
        local calories = self.player:getModData()['FoodGames'] and self.player:getModData()['FoodGames']['consumedCalories'] or 0
       -- self.CalSlider:setValue(  self.CalSlider:getValue())
        self.res = self.CalSlider:getCurrentValue()
    end ]]
end

function FoodGamesPanel:onMouseUpOutside(x, y)
    if not self:getIsVisible() then
        return
    end
    self.moving = false
    ISMouseDrag.dragView = nil
end


function FoodGamesPanel:new(x, y, width, height, player)
    local o = ISCollapsableWindow.new(self, x, y, width, height)
    setmetatable(o, self)
    self.__index = self
    o.player = player
    o.user = player:getUsername()
    if y == 0 then
        o.y = o:getMouseY() - (height / 2)
        o:setY(o.y)
    end
    if x == 0 then
        o.x = o:getMouseX() - (width / 2)
        o:setX(o.x)
    end

    o.width = width;
    local txtWidth = getTextManager():MeasureStringX(UIFont.Small, text) + 10;
    if width < txtWidth then
        o.width = txtWidth;
    end
    o.height = height;
    o.anchorLeft = true;
    o.anchorRight = true;
    o.anchorTop = true;
    o.anchorBottom = true;
    o.calData = player:getModData()['FoodGames']['consumedCalories'] or 0

    o.variableColor = {r = 1, g = 0.55, b = 1, a = 1}
    --o.borderColor = {r = 0, g = 0, b = 0.6, a = 1}
    o.borderColor = { r = 0.76, g = 0.59, b = 0.11, a = 1}
    o.backgroundColor = { r = 0.30, g = 0.30, b = 0.30, a =  0.4}--{ r = 0.12, g = 0.39, b = 0.77,  a = 1}
    o.buttonBorderColor = {r = 0.7, g = 0.7, b = 0.7, a = 1}
    o:setResizable(true)
    o.moveWithMouse = true
    --o.titlebarbkg = getTexture("media/ui/Panel_TitleBar.png");
    return o
end

function FoodGamesPanel:render()
    ISCollapsableWindow.render(self)
end

function FoodGamesPanel:initialise()
    ISCollapsableWindow.initialise(self)
    self:createChildren()
end


function FoodGames.context(player, context, worldobjects, test)
	local pl = getSpecificPlayer(player)
	local sq = clickedSquare
	local targ = clickedPlayer
	local obj = nil
	if not sq then return end
    local csq = pl:getCurrentSquare()
	if csq == sq then

        local optTip = context:addOptionOnTop("Food Games", worldobjects, function()
            FoodGames.open()
            getSoundManager():playUISound("UIActivateMainMenuItem")
            context:hideAndChildren()
        end)

        optTip.iconTexture = getTexture("media/ui/HomeLenderIcon.png")
        local tip = ISWorldObjectContextMenu.addToolTip()

        tip.description = "Consumed Calories:\n"..tostring(pl:getModData()['FoodGames']['consumedCalories'])
        optTip.toolTip = tip



--[[
        optTip.notAvailable = true
        optTip:setOptionChecked(optTip,  bool) ]]
    end

end
Events.OnFillWorldObjectContextMenu.Remove(FoodGames.context)
Events.OnFillWorldObjectContextMenu.Add(FoodGames.context)

