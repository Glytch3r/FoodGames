--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]



FoodGames = FoodGames or {}

function FoodGames.isZombieNearby(pl, rad)
    if not pl or not rad then return false end
    local cx, cy, cz = round(pl:getX()), round(pl:getY()), pl:getZ()
    local zeds = getCell():getZombieList()
    for i = 0, zeds:size() - 1 do
        local zed = zeds:get(i)
        if zed and not zed:isDead() and zed:getZ() == cz then
            local zx, zy = round(zed:getX()), round(zed:getY())
            local dx, dy = zx - cx, zy - cy
            if (dx * dx + dy * dy) <= (rad * rad) then
                return true
            end
        end
    end

    return false
end
function FoodGames.isUnarmed(pl)
    return tostring(WeaponType.getWeaponType(pl)) == 'barehand'
end
--[[ 
function FoodGames.isRestrictCast(pl)
    pl = pl or getPlayer()
    
    local barehandsOnly = SandboxVars.FoodGames.MagKneeToeBarehands
    local isBarehand = tostring(WeaponType.getWeaponType(pl)) == "barehand"

    local allowed = (not barehandsOnly) or (barehandsOnly and isBarehand)
    
    if not allowed then
        FoodGames.disableSkill(pl, 1, "MagKneeToe")
        FoodGames.disableSkill(pl, 2, "MagKneeToe")
    end

    return allowed
end
 ]]
-----------------------            ---------------------------
function FoodGames.doShotgun()
    local pl = getPlayer()
    if not pl then return end
    if not FoodGames.isUnarmed(pl) then return end
    
    local mode = FoodGames.getMode()
    if not mode then return end
    FoodGames.disableSkill(pl, 2, mode)
    if not (pl:HasTrait(mode) and FoodGames.getMode() == mode) then         
        FoodGames.disableSkill(pl, 1, mode)
        return
    end

    if not FoodGames.isActiveSkill(mode, 1) then return end
    local rad =  FoodGames.getRad(mode, 1)
    
    if  FoodGames.isZombieNearby(pl, rad) then   
        FoodGames.doAoE(1)  
    end
  

    --addSound(pl, pl:getX(), pl:getY(), pl:getZ(), SandboxVars.FoodGames.MetalSkillRadius1, 1)
  
end

Events.EveryOneMinute.Add(FoodGames.doShotgun)



function FoodGames.doShotgun2()
    local pl = getPlayer()
    if not pl then return end
    if not FoodGames.isUnarmed(pl) then return end
    
    local skillNum = 2 
    local mode = FoodGames.getMode()
    FoodGames.disableSkill(pl, 1, mode)

    if not (pl:HasTrait(mode) and mode == FoodGames.getMode()) then         
        FoodGames.disableSkill(pl, 2, mode)
        return
    end

    if not FoodGames.isActiveSkill(mode, skillNum) then return end
    
    if not FoodGames.isHasEnergy(pl, skillNum) then
        FoodGames.disableSkill(pl, skillNum, mode)
        return
    end

    local rad = FoodGames.getRad(mode, skillNum)
    FoodGames.doAoE(skillNum)
    FoodGames.doPulse(pl:getCurrentSquare(), rad, skillNum)

    timer:Simple(1.5, function() 
        FoodGames.disableSkill(pl, skillNum, mode)
    end)
end
-----------------------            ---------------------------


function FoodGames.doRoll(percent)
    return percent >= ZombRand(1, 101)
end

function FoodGames.doDmg(zed, skillNum)
    local pl = getPlayer()
    if not pl or not zed or not zed:isAlive() then return end
    
    local min, max, rad
    local dmg = 0
    local isMagKneeToe = FoodGames.getMode() == "MagKneeToe"
    local isGameBet = FoodGames.getMode() == "GameBet"

    if isMagKneeToe then
        if skillNum == 2 then
            min = SandboxVars.FoodGames.MetalMinZedDmg2
            max = SandboxVars.FoodGames.MetalMaxZedDmg2
            rad = SandboxVars.FoodGames.MetalSkillRadius2
            dmg =   ZombRand(min, max)
        else
            min = SandboxVars.FoodGames.MetalMinZedDmg1
            max = SandboxVars.FoodGames.MetalMaxZedDmg1
            rad = SandboxVars.FoodGames.MetalSkillRadius1
            dmg =   ZombRand(min, max)
            FoodGames.doPulse(pl:getCurrentSquare(), rad, 1)
        end
    elseif isGameBet then
        if skillNum == 2 then    
            dmg = SandboxVars.FoodGames.CardsZedDmg2
            rad = SandboxVars.FoodGames.CardsSkillRadius2
        else
            dmg = SandboxVars.FoodGames.CardsZedDmg1
            rad = SandboxVars.FoodGames.CardsSkillRadius1
            FoodGames.doPulse(pl:getCurrentSquare(), rad, 1)
        end
    else
        return
    end
    zed:setAttackedBy(pl)
    zed:setHealth(zed:getHealth() - dmg)
    zed:playSound("KatanaHit")

    if FoodGames.doRoll(50) then
        zed:setHitReaction("ShotBelly")
    else
        zed:setKnockedDown(true)
    end
end
-----------------------            ---------------------------
function FoodGames.getMultiHitCount(mode, skillNum)
    mode = mode or FoodGames.getMode()
    if not mode or not FoodGames.isDualSkilled(mode) then return 0 end
    local sData = SandboxVars.FoodGames
    local tab = {
        MagKneeToe = {
            [1] = sData.MetalMaxHitCount1,
            [2] = sData.MaxMetalHitCount2,
        },
        GameBet = {
            [1] = sData.CardsMaxHitCount1,
            [2] = sData.CardsMaxHitCount2,
        },
    }
    return tab[mode] and tab[mode][skillNum] or 0
end

function FoodGames.getRad(mode, skillNum)
    mode = mode or FoodGames.getMode()
    if not mode or not FoodGames.isDualSkilled(mode) then return 0 end
    local sData = SandboxVars.FoodGames
    local tab = {
        GameBet = {
            [1] = sData.CardsSkillRadius1,
            [2] = sData.CardsSkillRadius2,
        },
        MagKneeToe = {
            [1] = sData.MetalSkillRadius1,
            [2] = sData.MetalSkillRadius2,
        },
    }
    return tab[mode] and tab[mode][skillNum] or 0
end


-----------------------            ---------------------------

function FoodGames.doAoE(skillNum)
    local pl = getPlayer()
    if not pl or not FoodGames.isUnarmed(pl) then return end
    skillNum = skillNum or 1
    local mode = FoodGames.getMode()
    local maxZedCount = FoodGames.getMultiHitCount(mode, skillNum)
    local rangeLimit =  FoodGames.getRad(mode, skillNum)        

    if not FoodGames.isDualSkilled(mode) then return end
    

    local x, y, z = pl:getX(), pl:getY(), pl:getZ()
    local zombies = getCell():getZombieList()
    if not zombies then return end

    local rad = rangeLimit * rangeLimit
    local sorted = {}

    for i = 0, zombies:size() - 1 do
        local zed = zombies:get(i)
        if zed and not zed:isDead() and zed:getZ() == z then
            local dx = zed:getX() - x
            local dy = zed:getY() - y
            local distSq = dx * dx + dy * dy
            if distSq <= rad then
                table.insert(sorted, { zed = zed, distSq = distSq })
            end
        end
    end

    table.sort(sorted, function(a, b) return a.distSq < b.distSq end)
    for i = 1, math.min(maxZedCount, #sorted) do 
        if FoodGames.isHasEnergy(pl, skillNum) then
            pl:startMuzzleFlash()
            if FoodGames.consumeEnergy(pl, skillNum, mode) then
                FoodGames.doDmg(sorted[i].zed, 1)
            end
        else
            FoodGames.disableSkill(pl, skillNum, mode)
            break
        end
    end
end

-----------------------            ---------------------------


function FoodGames.doPulse(sq, rad, skillNum)
    local pl = getPlayer()
    if not pl or not isIngameState() then return end
    skillNum = skillNum or 1

    local isGameBet = FoodGames.getMode() == "GameBet"
    local str = "MagKneeToe_Skill"

    if isGameBet then
        str = "GameBet_Skill"
    end
    local sfx = tostring(str)..tostring(skillNum)
    pl:playSound(sfx)
    addSound(pl, pl:getX(), pl:getY(), pl:getZ(), rad, 1)

    sq = sq or pl:getCurrentSquare()
    local col = { r = 0.86, g = 0.36, b = 0.89 }


    FoodGames.animTimer = FoodGames.animTimer or {}
    FoodGames.marker = FoodGames.marker or {}

    if FoodGames.animTimer[skillNum] then
        timer:Stop(FoodGames.animTimer[skillNum])
        FoodGames.animTimer[skillNum] = nil
    end

    if FoodGames.marker[skillNum] then
        FoodGames.marker[skillNum]:remove()
        FoodGames.marker[skillNum] = nil
    end

    local steps = math.max(math.abs(rad - 1) + 1, 1)
    if steps < 1 then return end

    local currentStep = 0

    local function step()
        if FoodGames.marker[skillNum] then
            FoodGames.marker[skillNum]:remove()
            FoodGames.marker[skillNum] = nil
        end

        currentStep = currentStep + 1
        local t = currentStep / steps
        local radius = 1 + (rad - 1) * t

        FoodGames.marker[skillNum] = getWorldMarkers():addGridSquareMarker(
            "circle_only_highlight",
            "circle_only_highlight",
            sq,
            col.r, col.g, col.b,
            true,
            radius
        )

        local frameDelay = 1
        if currentStep < steps then
            FoodGames.animTimer[skillNum] = timer:Simple(frameDelay / 1000, step)
        else
            FoodGames.animTimer[skillNum] = timer:Simple(frameDelay / 1000, function()
                if FoodGames.marker[skillNum] then
                    FoodGames.marker[skillNum]:remove()
                    FoodGames.marker[skillNum] = nil
                end
                FoodGames.animTimer[skillNum] = nil
            end)
        end
    end

    step()
end
