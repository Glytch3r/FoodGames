--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]



FoodGames = FoodGames or {}

function FoodGames.isZombieNearby(pl, rad)
    if not pl or not rad then return false end
    local cx, cy, cz = round(pl:getX()), round(pl:getY()), pl:getZ()
    local zeds = getCell():getZombieList()
    for i = 0, zeds:size() - 1 do
        local zed = zeds:get(i)
        if zed and not zed:isDead() and zed:getZ() == cz then
            local zx, zy = round(zed:getX()), round(zed:getY())
            local dx, dy = zx - cx, zy - cy
            if (dx * dx + dy * dy) <= (rad * rad) then
                return true
            end
        end
    end

    return false
end

function FoodGames.isRestrictCast(pl)
    pl = pl or getPlayer()
    
    local barehandsOnly = SandboxVars.FoodGames.MagKneeToeBarehands
    local isBarehand = tostring(WeaponType.getWeaponType(pl)) == "barehand"

    local allowed = (not barehandsOnly) or (barehandsOnly and isBarehand)

    if not allowed then
        FoodGames.disableSkill(pl, 1, "MagKneeToe")
        FoodGames.disableSkill(pl, 2, "MagKneeToe")
    end

    return allowed
end
-----------------------            ---------------------------
function FoodGames.doShotgun()
    local pl = getPlayer()
    if not pl then return end
    if not FoodGames.isRestrictCast(pl) then return end

    FoodGames.disableSkill(pl, 2, "MagKneeToe")
    if not (pl:HasTrait("MagKneeToe") and FoodGames.getMode() == "MagKneeToe") then         
        FoodGames.disableSkill(pl, 1, "MagKneeToe")
        return
    end

    if not FoodGames.isActiveSkill("MagKneeToe", 1) then return end
    if not FoodGames.isZombieNearby(pl, SandboxVars.FoodGames.SkillRadius1) then return end


    --addSound(pl, pl:getX(), pl:getY(), pl:getZ(), SandboxVars.FoodGames.SkillRadius1, 1)
    FoodGames.doAoE(1) 
end

Events.EveryOneMinute.Add(FoodGames.doShotgun)

function FoodGames.doShotgun2()
    local pl = getPlayer()
    if not pl then return end
    if not FoodGames.isRestrictCast(pl) then return end

    local mode = FoodGames.getMode()
    FoodGames.disableSkill(pl, 1, "MagKneeToe")

    if not (pl:HasTrait("MagKneeToe") and mode == "MagKneeToe") then         
        FoodGames.disableSkill(pl, 2, "MagKneeToe")
        return
    end

    if not FoodGames.isActiveSkill("MagKneeToe", 2) then return end

    if not FoodGames.consumeEnergy(pl, 2, "MagKneeToe") then
        FoodGames.disableSkill(pl, 2, "MagKneeToe")
        return
    end

    local rad = SandboxVars.FoodGames.SkillRadius2
    FoodGames.doAoE(2)
    FoodGames.doPulse(pl:getCurrentSquare(), rad, 2)

    timer:Simple(1, function() 
        FoodGames.disableSkill(pl, 2, "MagKneeToe")
    end)
end
-----------------------            ---------------------------


function FoodGames.doRoll(percent)
    return percent >= ZombRand(1, 101)
end

function FoodGames.doDmg(zed, skillNum)
    local pl = getPlayer()
    if not pl or not zed or not zed:isAlive() then return end

    local min, max, rad
    if skillNum == 2 then
        min = SandboxVars.FoodGames.MinZedDmg2
        max = SandboxVars.FoodGames.MaxZedDmg2
        rad = SandboxVars.FoodGames.SkillRadius2
    else
        min = SandboxVars.FoodGames.MinZedDmg1
        max = SandboxVars.FoodGames.MaxZedDmg1
        rad = SandboxVars.FoodGames.SkillRadius1
        FoodGames.doPulse(pl:getCurrentSquare(), rad, 1)
    end

    zed:setAttackedBy(pl)
    local dmg = ZombRand(min, max)
    zed:setHealth(zed:getHealth() - dmg)
    zed:playSound("KatanaHit")

    if FoodGames.doRoll(50) then
        zed:setHitReaction("ShotBelly")
    else
        zed:setKnockedDown(true)
    end
end

-----------------------            ---------------------------
function FoodGames.doAoE(skillNum)
    local pl = getPlayer()
    if not pl or not FoodGames.isRestrictCast(pl) then return end

    local maxZedCount = SandboxVars.FoodGames.MaxHitCount1
    local rangeLimit = SandboxVars.FoodGames.SkillRadius1
    if skillNum == 2 then
        maxZedCount = SandboxVars.FoodGames.MaxHitCount2
        rangeLimit = SandboxVars.FoodGames.SkillRadius2
    end

    local x, y, z = pl:getX(), pl:getY(), pl:getZ()
    local zombies = getCell():getZombieList()
    if not zombies then return end

    local rad = rangeLimit * rangeLimit
    local sorted = {}

    for i = 0, zombies:size() - 1 do
        local zed = zombies:get(i)
        if zed and not zed:isDead() and zed:getZ() == z then
            local dx = zed:getX() - x
            local dy = zed:getY() - y
            local distSq = dx * dx + dy * dy
            if distSq <= rad then
                table.insert(sorted, { zed = zed, distSq = distSq })
            end
        end
    end

    table.sort(sorted, function(a, b) return a.distSq < b.distSq end)

    for i = 1, math.min(maxZedCount, #sorted) do
        if skillNum == 1 then
            if FoodGames.consumeEnergy(pl, 1, "MagKneeToe") then
                pl:startMuzzleFlash()
                FoodGames.doDmg(sorted[i].zed, 1)
            else
                FoodGames.disableSkill(pl, 1, "MagKneeToe")
                break
            end
        else
            pl:startMuzzleFlash()
            FoodGames.doDmg(sorted[i].zed, 2)
        end
    end
end


-----------------------            ---------------------------


function FoodGames.doPulse(sq, rad, skillNum)
    local pl = getPlayer()
    if not pl or not isIngameState() then return end
    skillNum = skillNum or 1
    if skillNum == 2 then
        pl:playSound("MagKneeToe_Skill2")
    else
        pl:playSound("MagKneeToe_Skill1")
    end
    addSound(pl, pl:getX(), pl:getY(), pl:getZ(), rad, 1)

    sq = sq or pl:getCurrentSquare()
    local col = { r = 0.86, g = 0.36, b = 0.89 }

    -- Use skillNum-specific marker/timer to avoid overlap between skills
    FoodGames.animTimer = FoodGames.animTimer or {}
    FoodGames.marker = FoodGames.marker or {}

    if FoodGames.animTimer[skillNum] then
        timer:Stop(FoodGames.animTimer[skillNum])
        FoodGames.animTimer[skillNum] = nil
    end

    if FoodGames.marker[skillNum] then
        FoodGames.marker[skillNum]:remove()
        FoodGames.marker[skillNum] = nil
    end

    local steps = math.max(math.abs(rad - 1) + 1, 1)
    if steps < 1 then return end

    local currentStep = 0

    local function step()
        if FoodGames.marker[skillNum] then
            FoodGames.marker[skillNum]:remove()
            FoodGames.marker[skillNum] = nil
        end

        currentStep = currentStep + 1
        local t = currentStep / steps
        local radius = 1 + (rad - 1) * t

        FoodGames.marker[skillNum] = getWorldMarkers():addGridSquareMarker(
            "circle_only_highlight",
            "circle_only_highlight",
            sq,
            col.r, col.g, col.b,
            true,
            radius
        )

        local frameDelay = 1
        if currentStep < steps then
            FoodGames.animTimer[skillNum] = timer:Simple(frameDelay / 1000, step)
        else
            FoodGames.animTimer[skillNum] = timer:Simple(frameDelay / 1000, function()
                if FoodGames.marker[skillNum] then
                    FoodGames.marker[skillNum]:remove()
                    FoodGames.marker[skillNum] = nil
                end
                FoodGames.animTimer[skillNum] = nil
            end)
        end
    end

    step()
end
