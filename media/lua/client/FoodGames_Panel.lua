--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

FoodGames = FoodGames or {}

require "ISUI/ISCollapsableWindow"

FoodGamesPanel = ISCollapsableWindow:derive("FoodGamesPanel")
FoodGames.panelBG_0 = getTexture("media/ui/HomeLenderPanel_0.png")
FoodGames.panelBG_1 = getTexture("media/ui/HomeLenderPanel_1.png")

function FoodGamesPanel:update()
    ISCollapsableWindow.update(self)

    --[[ local Catapult = self.player:getModData()['FoodGames']['Catapult']
    local bg = FoodGames.panelBG_0
    if Catapult then
        bg = FoodGames.panelBG_1
    end
    if self.bg_0:getImage() ~= bg then
        self.bg_0:setImage(bg)
    end
     ]]
end


function FoodGames.toggle()
    if FoodGamesPanel.instance ~= nil then
        FoodGamesPanel:close()
    else
        FoodGames.open()
    end
end
function FoodGames.open()
    local modData = getPlayer():getModData()
    modData['FoodGames'] = modData['FoodGames'] or {}
    modData['FoodGames']['consumedCalories'] = modData['FoodGames']['consumedCalories'] or 0
    modData['FoodGames']['Catapult'] = modData['FoodGames']['Catapult'] or false
    if FoodGamesPanel.instance == nil then
        local sW = getCore():getScreenWidth()
        local sH = getCore():getScreenHeight()
        local sX = sW / 3 - 100
        local sY = sH / 2 - 350
        local W = 345
        local H = 210

        FoodGamesPanel.instance = FoodGamesPanel:new(sX, sY, W, H, getPlayer())
        FoodGamesPanel.instance:initialise()
        FoodGamesPanel.instance:addToUIManager()
        return FoodGamesPanel.instance
    else
        FoodGamesPanel.instance:close()
    end
end


function FoodGames.refresh()
    if FoodGamesPanel.instance ~= nil then
        FoodGamesPanel:close()
        FoodGames.open()
    end
end

function FoodGamesPanel:close()
    if FoodGamesPanel.instance ~= nil then
        FoodGamesPanel.instance:setVisible(false)
        FoodGamesPanel.instance:removeFromUIManager()
        FoodGamesPanel.instance = nil
    end
end

function FoodGamesPanel:OnBtnPress()
    local modData = self.player:getModData()
    local fgData = modData['FoodGames']
    fgData['Catapult'] = not fgData['Catapult']

    local sound = fgData['Catapult'] and "HomeLander_ToggleOn" or "HomeLander_ToggleOff"
    getSoundManager():playUISound(sound)
end

function FoodGamesPanel:createChildren()
    ISCollapsableWindow.createChildren(self)

    self:setTitle("Food Game Calories");


    local data = self.player:getModData()['FoodGames'] and self.player:getModData()['FoodGames']['consumedCalories'] or 0
    local xOffset = 12
    local yOffset = 20
    self.bg_0 = ISImage:new(xOffset, yOffset, 322, 172, FoodGames.panelBG_0)
    self.bg_0.scaled = true
    self.bg_0:initialise()
    self:addChild(self.bg_0)

    self.bg_1 = ISImage:new(xOffset, yOffset, 322, 172, FoodGames.panelBG_1)
    self.bg_1.scaled = true
    self.bg_1:initialise()
	self.bg_1:setVisible(false)
    self:addChild(self.bg_1)


    self.Catapult = self.player:getModData()['FoodGames']['Catapult']
    self.ArrowLeft_0 = getTexture("media/ui/HomeLender_ArrowLeft_0.png")
    self.ArrowRight_0 = getTexture("media/ui/HomeLender_ArrowRight_0.png")
    self.ArrowLeft_1 = getTexture("media/ui/HomeLender_ArrowLeft_1.png")
    self.ArrowRight_1 = getTexture("media/ui/HomeLender_ArrowRight_1.png")

    self.Icon_0 = getTexture("media/ui/HomeLenderIcon.png")
    self.Icon_1 = getTexture("media/ui/HomeLenderIcon_Red.png")


    self.icon = ISButton:new(xOffset+32, 35, 32, 32, "", self, self.OnBtnPress)
    self.icon.internal = "Icon"
    self.icon:setImage(self.Icon_0)
    self.icon:forceImageSize(32, 32)
	self.icon:initialise();
	self.icon:instantiate();
    self:addChild(self.icon)
	self.icon.borderColor = {r=0, g=0, b=0, a=0};
	self.icon.displayBackground = false
--[[
    self.icon = ISImage:new(xOffset+32, 35, 32, 32, getTexture("media/ui/HomeLenderIcon.png"));
    self.icon.scaled = true;
    self.icon:initialise()
    self:addChild(self.icon); ]]

    self.CalSlider = ISSliderPanel:new(xOffset+35, self.height / 4 + 70, 250, 32, self, self.OnSliderChange)
    self.CalSlider.anchorTop = false
    self.CalSlider.anchorBottom = true
    self.CalSlider:initialise()
    self.CalSlider:instantiate()
    self.CalSlider:setValues(0.0, 99999, 0.1, 1, true)
    self.CalSlider:setHeight(32)
    self:addChild(self.CalSlider)
    self.CalSlider.texBtnLeft = self.ArrowLeft_0
    self.CalSlider.texBtnRight = self.ArrowRight_0
    self.CalSlider:setCurrentValue(data)
    self.CalSlider.sliderColor = self.backgroundColor
    self.CalSlider.sliderMouseOverColor = {r=1.0, g=0, b=0, a=1.0};

end
function FoodGamesPanel:onMouseMoveOutside(dx, dy)

	self.mouseover = false;
end

function FoodGamesPanel:onMouseUp(x,y)
	if self.onclick then
		self.onclick(self.target, self);
	end
end

-----------------------            ---------------------------
function FoodGamesPanel:prerender()
    ISCollapsableWindow.prerender(self)

    if not self.CalSlider then return end
    if not self.player then return end

    local modData = self.player:getModData()
    if not modData then return end

    local foodGames = modData['FoodGames']
    if not foodGames then return end

    local calories = tonumber(foodGames['consumedCalories']) or 0
    calories = math.max(0, math.min(99999, calories))

    if math.abs(self.CalSlider:getCurrentValue() - calories) > 0.01 then
       -- self.CalSlider:setValue(calories)
    end


    local themeCol = {r= 0.76, g = 0.59, b = 0.11}

    self.Catapult = self.player:getModData()['FoodGames']['Catapult']
    if self.Catapult then
        --turn on
        self.icon:setImage(self.Icon_1)
        self.bg_0:setVisible(false)
        self.bg_1:setVisible(true)
        self.CalSlider.texBtnLeft = self.ArrowLeft_1
        self.CalSlider.texBtnRight = self.ArrowRight_1
        themeCol =  {r= 1, g = 0, b = 0}
    else
        --turn off
        self.icon:setImage(self.Icon_0)
        self.bg_0:setVisible(true)
        self.bg_1:setVisible(false)
        self.CalSlider.texBtnLeft = self.ArrowLeft_0
        self.CalSlider.texBtnRight = self.ArrowRight_0
    end
    self.borderColor = { r = themeCol.r, g = themeCol.g, b = themeCol.b, a = 1}
    self:drawTextCentre(tostring(math.floor(calories)), self:getWidth() / 2, 32, themeCol.r,themeCol.g, themeCol.b, 1, UIFont.Large)

    local storedFood = FoodGames.convertDaysToYMD(tonumber(calories))
    self:drawTextCentre(tostring(storedFood), self:getWidth() / 2, 70, themeCol.r,themeCol.g, themeCol.b, 1, UIFont.Medium)
end


function FoodGamesPanel:OnSliderChange()
    self.CalSlider.sliderColor = self.borderColor
    if getCore():getDebug() then
        self.player:getModData()['FoodGames']['consumedCalories']  =  self.CalSlider:getCurrentValue()
    end

end
--[[
function FoodGamesPanel:onMouseUpOutside(x, y)
    if not self.isCollapsed then
        self:collapse()
    end
    if not self:getIsVisible() then
        return
    end
    self.moving = false
    ISMouseDrag.dragView = nil
end
function FoodGamesPanel:onMouseUp(x,y)
    if self.isCollapsed then
        self:uncollapse()
    end
end
 ]]
function FoodGamesPanel:new(x, y, width, height, player)
    local o = ISCollapsableWindow.new(self, x, y, width, height)
    setmetatable(o, self)
    self.__index = self
    o.player = player
    o.user = player:getUsername()
    if y == 0 then
        o.y = o:getMouseY() - (height / 2)
        o:setY(o.y)
    end
    if x == 0 then
        o.x = o:getMouseX() - (width / 2)
        o:setX(o.x)
    end

    o.width = width;
    local txtWidth = getTextManager():MeasureStringX(UIFont.Medium, text) + 10;
    if width < txtWidth then
        o.width = txtWidth;
    end
    o.height = height;
    o.anchorLeft = true;
    o.anchorRight = true;
    o.anchorTop = true;
    o.anchorBottom = true;
    o.calData = player:getModData()['FoodGames']['consumedCalories'] or 0

    o.variableColor = {r = 1, g = 0.55, b = 1, a = 1}
    --o.borderColor = {r = 0, g = 0, b = 0.6, a = 1}
    o.borderColor = { r = 0.76, g = 0.59, b = 0.11, a = 1}
    o.backgroundColor = { r = 0.30, g = 0.30, b = 0.30, a =  0.1}--{ r = 0.12, g = 0.39, b = 0.77,  a = 1}
    o.buttonBorderColor = {r = 0.7, g = 0.7, b = 0.7, a = 1}
    o:setResizable(true)
    o.resizable = true
    --o.moveWithMouse = true
    --o.titlebarbkg = getTexture("media/ui/Panel_TitleBar.png");
    return o
end

function FoodGamesPanel:render()
    ISCollapsableWindow.render(self)
end

function FoodGamesPanel:initialise()
    ISCollapsableWindow.initialise(self)
    self:createChildren()
end


function FoodGames.context(player, context, worldobjects, test)
	local pl = getSpecificPlayer(player)
	if not pl:HasTrait("HomeLender") then return end
	local sq = clickedSquare
	local targ = clickedPlayer
	local obj = nil
	if not sq then return end
    local csq = pl:getCurrentSquare()
	if csq == sq then
        local Catapult =  pl:getModData()['FoodGames']['Catapult']
        local optTip = context:addOptionOnTop("Food Games", worldobjects, function()
            FoodGames.open()
            getSoundManager():playUISound("UIActivateMainMenuItem")
            context:hideAndChildren()
        end)

        local ico = "media/ui/HomeLenderIcon.png"
        if Catapult then
            ico = "media/ui/HomeLenderIcon_Red.png"
        end
        optTip.iconTexture = getTexture(ico)
        local tip = ISWorldObjectContextMenu.addToolTip()
        tip:setTexture(ico)
        local calories = pl:getModData()['FoodGames']['consumedCalories']
        local storedFood = FoodGames.convertDaysToYMD(tonumber(calories))
        tip.description = "HomeLender Mode:\n"..tostring(Catapult).."\n\n".."Consumed Calories:\n"..tostring(calories).."\n\n".."Stored Food:\n"..tostring(storedFood)
        optTip.toolTip = tip



--[[
        optTip.notAvailable = true
        optTip:setOptionChecked(optTip,  bool) ]]
    end

end
Events.OnFillWorldObjectContextMenu.Remove(FoodGames.context)
Events.OnFillWorldObjectContextMenu.Add(FoodGames.context)

